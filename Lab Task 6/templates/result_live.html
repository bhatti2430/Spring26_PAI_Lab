<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Live Processing - AI Video Object Counter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
  </head>
  <body data-theme="light">
    <nav class="navbar navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">
          <i class="bi bi-camera-video me-2"></i>AI Video Object Counter
        </a>
        <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">
          <i class="bi bi-moon-fill"></i>
        </button>
      </div>
    </nav>

    <main class="container my-5">
      <div class="row g-4">
        <div class="col-lg-8">
          <div class="card shadow-lg">
            <div class="card-body">
              <div class="d-flex align-items-center mb-4">
                <div class="bg-info bg-opacity-10 p-3 rounded-3 me-3">
                  <i class="bi bi-activity fs-4 text-info"></i>
                </div>
                <div>
                  <h5 class="card-title mb-0">Live Processing</h5>
                  <p class="text-muted small mb-0">Real-time frame analysis in progress</p>
                </div>
                <div class="ms-auto">
                  <a href="/" class="btn btn-outline-secondary btn-sm">&larr; Back to Home</a>
                </div>
              </div>

              <div class="ratio ratio-16x9 mb-4 rounded-2 overflow-hidden shadow-sm bg-dark">
                <img id="live-stream" src="/stream/{{ job_id }}" alt="live stream" style="object-fit: cover;" />
              </div>

              <div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <small class="text-muted fw-bold">Processing Progress</small>
                  <small id="live-status" class="text-muted fw-bold">Starting...</small>
                </div>
                <div class="progress" style="height: 28px;">
                  <div id="live-progress" class="progress-bar fw-bold d-flex align-items-center justify-content-center" style="width:0%">0%</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-lg mb-4">
            <div class="card-body">
              <h6 class="card-title mb-3">
                <i class="bi bi-info-circle me-2"></i>Job Information
              </h6>
              <div class="bg-light bg-opacity-50 p-3 rounded-2 mb-3">
                <div class="mb-3 pb-3 border-bottom">
                  <small class="text-muted d-block mb-1">Job ID</small>
                  <code class="text-primary">{{ job_id }}</code>
                </div>
                <div class="mb-3 pb-3 border-bottom">
                  <small class="text-muted d-block mb-1">Current Status</small>
                  <span id="job-status" class="badge bg-primary">queued</span>
                </div>
                <div>
                  <small class="text-muted d-block mb-1">Objects Counted</small>
                  <h4 class="mb-0">
                    <i class="bi bi-counter text-success me-2"></i>
                    <span id="job-count">0</span>
                  </h4>
                </div>
              </div>

              <div id="done-actions" class="d-none">
                <div class="alert alert-success border-0 mb-3" role="alert">
                  <i class="bi bi-check-circle-fill me-2"></i>Processing Complete!
                </div>
                <a id="view-output" class="btn btn-primary btn-sm w-100 mb-2" href="#">
                  <i class="bi bi-play-circle me-2"></i>View Processed Video
                </a>
                <a class="btn btn-outline-secondary btn-sm w-100" href="/">
                  <i class="bi bi-plus-circle me-2"></i>Process Another
                </a>
              </div>
            </div>
          </div>

          <div class="card shadow-lg">
            <div class="card-body">
              <h6 class="card-title mb-2">
                <i class="bi bi-lightbulb me-2 text-warning"></i>Troubleshooting
              </h6>
              <p class="small text-muted mb-0">If the live stream freezes or becomes unresponsive, the processing may have completed. Click the <strong>"View Processed Video"</strong> button to see the final result.</p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="text-center py-4 mt-5 border-top">
      <small class="text-muted">
        <i class="bi bi-diagram-3 me-2"></i>Built with Flask, OpenCV & AI Technology
      </small>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/main.js"></script>
    <script>
      const jobId = "{{ job_id }}";
      const statusEl = document.getElementById('job-status');
      const countEl = document.getElementById('job-count');
      const progressBar = document.getElementById('live-progress');
      const liveStatus = document.getElementById('live-status');
      const doneActions = document.getElementById('done-actions');
      const viewOutput = document.getElementById('view-output');

      async function poll() {
        try {
          const res = await fetch(`/job_status/${jobId}`);
          if (!res.ok) { liveStatus.textContent = 'Job missing'; return; }
          const json = await res.json();
          statusEl.textContent = json.status;
          countEl.textContent = json.total || 0;

          if (json.status === 'processing') {
            liveStatus.textContent = 'Processing...';
            progressBar.style.width = '40%';
            progressBar.textContent = 'Processing';
            statusEl.className = 'badge bg-warning';
          } else if (json.status === 'done' || json.finished) {
            liveStatus.textContent = 'Completed';
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            progressBar.classList.remove('bg-primary');
            progressBar.classList.add('bg-success');
            statusEl.className = 'badge bg-success';
            doneActions.classList.remove('d-none');
            if (json.output) {
              viewOutput.href = json.output;
            }
            return;
          } else if (json.status === 'error') {
            liveStatus.textContent = 'Error';
            progressBar.classList.add('bg-danger');
            statusEl.className = 'badge bg-danger';
            doneActions.classList.remove('d-none');
            return;
          }
        } catch (e) {
          liveStatus.textContent = 'Connection error';
        }
        setTimeout(poll, 1000);
      }

      poll();
    </script>
  </body>
</html>
